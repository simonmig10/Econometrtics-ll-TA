---
title: "Lecture 4"
author: "Simon"
date: "2/10/2022"
output: html_document
---

# ARIMA(p,q) process


# Test for stationarity

## DF-test

```{r}
set.seed(123123)
Yt <- arima.sim(list(order = c(0, 1, 0)), n = 100)
TT <- 100
Yt <- ts(cumsum(rnorm(TT)))

```


```{r}
library(dynlm)
summary(dfuller.reg <- dynlm(diff(Yt) ~ 0 + L(Yt, 1))) # 0 means no intercept in the regression
```



```{r}
library(Quandl)
bnp = Quandl("FRED/GDPC1", start_date="1970-01-01", end_date="2018-12-01", type="ts")
bnp=ts(bnp, start=c(1970,1), end=c(2018,4), frequency = 4) # format as a time series object


plot(bnp)
```


```{r}
Ytd=diff(Yt) # We take the first difference of Yt
```

```{r}
summary(dfuller.reg <- dynlm(diff(Ytd) ~0 + L(Ytd, 1)))

```


### Exampple Testing US GDP

```{r}
# install.packages("Quandl")
library(Quandl)
bnp = Quandl("FRED/GDPC1", start_date="1970-01-01", end_date="2018-12-01", type="ts")
bnp=ts(bnp, start=c(1970,1), end=c(2018,4), frequency = 4) # format as a time series object
plot(bnp)
```

**DF test with no constant or intercept**

```{r}
library(dynlm)
summary(dfuller.reg <- dynlm(diff(bnp) ~ 0 + L(bnp, 1))) # 0 means no intercept in the regression
```
**DF test with a constant**
```{r}
library(dynlm)
summary(dfuller.reg <- dynlm(diff(bnp) ~ 1 + L(bnp, 1))) # 0 means no intercept in the regression
```

```{r}
library(dynlm)
summary(dfuller.reg <- dynlm(diff(bnp) ~ 1 + L(bnp, 1) + trend(diff(bnp))))

```



We fail to reject that pi=0 and that the series has unit root. 
So we take the first difference 


```{r}
Ytd=diff(bnp) # We take the first difference of US GDP
```

```{r}
library(dynlm)
summary(dfuller.reg <- dynlm(diff(Ytd) ~0 + L(Ytd, 1)))

```
```{r}
summary(dfuller.reg <- dynlm(diff(Ytd) ~1 + L(Ytd, 1)))
```

```{r}
summary(dfuller.reg <- dynlm(diff(Ytd) ~1 + L(Ytd, 1) + trend(Ytd)))

```


### Exercise

Get data for quarterly GDP for Denmark, and perform a unit root test
using DF test.





```{r}
library(readxl)
Danish_GDP <- read_excel("Danish_GDP.xlsx")

bnp_dk= ts(Danish_GDP$bnp, start= c(1995,1), end = c(2022,2), frequency = 4)
```



First seasonalize the data: 

```{r}
X <- cycle(bnp_dk)
q1 <- ifelse(X == "1", 1, 0)
q2 <- ifelse(X == "2", 1, 0)
q3 <- ifelse(X == "3", 1, 0)
q4 <- ifelse(X == "4", 1, 0)
```


```{r}
summary(bnp_dk.reg <- lm(bnp_dk ~ q1 + q2 + q3)); mean_bnp_dk= mean(bnp_dk)
```

```{r}
bnp_dk_de=ts(residuals(bnp_dk.reg)+mean_bnp_dk, start =c(1995,1), frequency = 4)
```



```{r}
summary(dfuller.reg <- dynlm(diff(bnp_dk_de) ~ 0 + L(bnp_dk_de, 1)))
```


We add a constant: 

```{r}
summary(dfuller.reg <- dynlm(diff(bnp_dk_de) ~ 1 + L(bnp_dk_de, 1)))
```


We add a trend 
```{r}
summary(dfuller.reg <- dynlm(diff(bnp_dk_de) ~ 1 + L(bnp_dk_de, 1)+ trend(bnp_dk_de)))

plot(bnp_dk_de)
```


Looks like the variable is trend stationary!



## ADF test

```{r}
library(dynlm)
library(urca)
library(forecast)
library(car)
library(stringr)
```


```{r}
model<-dynlm(diff(bnp)~1 + L(bnp,1) + trend(diff(bnp)) )
res=residuals(model)
acf(res); pacf(res)

```

We can see the series include serial correlation 



```{r}
model_start <- dynlm(diff(bnp) ~ 1 + L(bnp, 1) + L(diff(bnp), 1:12) + trend(diff(bnp)))
summary(model_start)

```

You can remove lags 1 by 1 as in slides 
Or use the F-test to remove more lags,
BUT you need to test for normality and serial correlation to make sure the standard error is not biased!
We will test for serial correlation in the end. 


```{r}
res_start= residuals(model_start)
shapiro.test(res_start)
```


Seems like we should fix normality, but im lazy atm. 

F-test

```{r}
 vars_1 <- str_c("L(diff(bnp), 1:12)", c(10:12, 3:7))
```

```{r}


vars_out_1 <- c(vars_1)
vars_out_1
 
linearHypothesis(model_start, vars_out_1, rep(0, length(vars_out_1)))

```
```{r}
model <- dynlm(diff(bnp) ~ 1 + L(bnp, 1) + L(diff(bnp), c(1,2,8,9)) + trend(diff(bnp)))
summary(model)
```



We cccan now test for serial correlation, we use the funcktion Hamid created 

```{r}
arpdiag <- function(series, lags) {
x <- mat.or.vec(lags, 1)
y <- mat.or.vec(lags, 1)
y <- y + 0.05
for (i in 1:lags) {
x[i] <- Box.test(series, lag = i, type = "Ljung-Box")$p.value
}
plot(x, xlab = "Lags", ylab = "p-value H0: no
Autocorrelation", type = "p",
main = "Ljung-Box Test for
Autocorrelation", ylim = c(0, 1))
axis(1, 1:lags)
abline(0.05, 0, lty = 2, col = "blue")
}
```


```{r}
res_model= residuals(model)
arpdiag(res_model, 12)
```
We have removed serial correlaion, lets go!




### Exercise 





